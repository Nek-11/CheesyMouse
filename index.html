<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheesyMouse - Wine Cellar Adventure</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="titleScreen">
            <h1>CHEESYMOUSE</h1>
            <p>Navigate through the wine cellar<br><br>Collect cheese, avoid the bottles!</p>
            <button id="startBtn">START GAME</button>
        </div>
        
        <div id="ui">
            <div id="score">0</div>
        </div>
        
        <div id="gameOver">
            <h2>GAME OVER</h2>
            <p>The mouse got caught!</p>
            <p id="finalScore">CHEESE COLLECTED: 0</p>
            <button id="restartBtn">TRY AGAIN</button>
        </div>
        
        <div id="instructions">
            PRESS SPACEBAR OR CLICK TO JUMP
        </div>
    </div>

    <!-- Load scripts in dependency order -->
    <script src="js/utils/GIFPlayer.js"></script>
    <script src="js/core/GameState.js"></script>
    <script src="js/systems/AssetLoader.js"></script>
    <script src="js/entities/Mouse.js"></script>
    <script src="js/systems/GameRenderer.js"></script>
    <script src="js/systems/GameLogic.js"></script>
    
    <!-- Fixed main game script -->
    <script>
        // Main game initialization and loop
        class CheesyMouseGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = false;

                // Mobile detection and setup (detect once to avoid performance issues)
                this.isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                this.setupMobileCanvas();

                // UI elements
                this.scoreElement = document.getElementById('score');
                this.gameOverElement = document.getElementById('gameOver');
                this.finalScoreElement = document.getElementById('finalScore');
                this.restartBtn = document.getElementById('restartBtn');
                this.titleScreen = document.getElementById('titleScreen');
                this.startBtn = document.getElementById('startBtn');
                this.instructionsElement = document.getElementById('instructions');

                // Update instructions based on device
                this.updateInstructions();

                // Initialize systems
                this.assetLoader = new AssetLoader();
                this.audioContext = null;
                
                // Game entities (initialized after assets load)
                this.mouse = null;
                this.renderer = null;
                this.gameLogic = null;

                // Performance profiling
                this.perf = {
                    lastLogTime: 0,
                    frameCount: 0,
                    update: 0,
                    render: 0,
                    drawMouse: 0,
                    total: 0
                };

                console.log('CheesyMouseGame constructor completed');
            }

            setupMobileCanvas() {
                if (this.isMobile) {
                    // Mouse stays at left edge for mobile
                    gameState.config.mouse.startX = 60;
                }
            }

            updateInstructions() {
                if (this.isMobile) {
                    this.instructionsElement.textContent = 'TOUCH TO JUMP';
                } else {
                    this.instructionsElement.textContent = 'PRESS SPACEBAR OR CLICK TO JUMP';
                }
            }

            async init() {
                console.log('Starting game initialization...');
                
                // Load all assets
                this.assetLoader.loadAll(() => {
                    console.log('Assets loaded, calling onAssetsLoaded...');
                    this.onAssetsLoaded();
                });
            }

            onAssetsLoaded() {
                console.log('Assets loaded, initializing game entities...');
                
                try {
                    // Initialize game entities with loaded assets
                    this.mouse = new Mouse(
                        gameState, 
                        this.assetLoader.getAllGIFPlayers(), 
                        this.canvas, 
                        this.ctx
                    );

                    this.renderer = new GameRenderer(
                        this.ctx, 
                        this.canvas, 
                        gameState, 
                        this.assetLoader
                    );

                                         this.gameLogic = new GameLogic(gameState, this.mouse, this.assetLoader);
                     
                     // Set up collision callbacks for game over
                     this.gameLogic.setCollisionCallback(() => {
                         this.gameOver();
                     });
                     
                     this.mouse.setBoundaryCollisionCallback(() => {
                         this.gameOver();
                     });
                     
                     this.gameLogic.setCheeseCollectionCallback(() => {
                         this.playMp3Sound('mouseEats');
                     });

                                     // Setup event listeners
                this.setupEventListeners();
                
                // Start game loop
                console.log('Starting game loop...');
                this.gameLoop();
                    
                } catch (error) {
                    console.error('Error in onAssetsLoaded:', error);
                }
            }

            setupEventListeners() {
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.initAudio();
                        
                        if (!gameState.gameStarted) {
                            this.startGame();
                        } else {
                            this.handleJump();
                        }
                    }
                });

                // Separate mobile and desktop input handling
                if (this.isMobile) {
                    // Mobile: Only touch events
                    document.addEventListener('touchstart', (e) => {
                        // Prevent clicks on buttons from triggering a jump
                        if (e.target.tagName.toLowerCase() === 'button') {
                            return;
                        }
                        
                        e.preventDefault(); // Prevent mouse events from firing
                        this.initAudio();
                        
                        if (!gameState.gameStarted) {
                            this.startGame();
                        } else {
                            this.handleJump();
                        }
                    });
                } else {
                    // Desktop: Only mouse events
                    document.addEventListener('mousedown', (e) => {
                        // Prevent clicks on buttons from triggering a jump
                        if (e.target.tagName.toLowerCase() === 'button') {
                            return;
                        }
                        
                        this.initAudio();
                        
                        if (!gameState.gameStarted) {
                            this.startGame();
                        } else {
                            this.handleJump();
                        }
                    });
                }

                // UI buttons
                this.startBtn.addEventListener('click', () => {
                    this.initAudio();
                    this.startGame();
                });

                this.restartBtn.addEventListener('click', () => {
                    this.startGame();
                });
            }

            initAudio() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Load sound files
                if (!this.sounds) {
                    this.sounds = {
                        mouseEats: new Audio('sounds/mouse-eats.mp3'),
                        mouseDies: new Audio('sounds/mouse-dies.mp3'),
                        jump: new Audio('sounds/jump.mp3')
                    };
                    
                    // Set volume levels
                    this.sounds.mouseEats.volume = 1.0;
                    this.sounds.mouseDies.volume = 0.6;
                    this.sounds.jump.volume = 0.5;
                }
            }

            playSound(frequency, duration, type = 'square', volume = 0.1) {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playMp3Sound(soundName) {
                if (!this.sounds || !this.sounds[soundName]) {
                    console.warn(`Sound ${soundName} not loaded`);
                    return;
                }
                
                try {
                    // Reset the audio to start from beginning
                    this.sounds[soundName].currentTime = 0;
                    this.sounds[soundName].play().catch(e => {
                        console.warn(`Failed to play sound ${soundName}:`, e);
                    });
                } catch (error) {
                    console.warn(`Error playing sound ${soundName}:`, error);
                }
            }



            handleJump() {
                if (this.mouse && this.mouse.jump()) {
                    // Create jump particles
                    this.gameLogic.createJumpParticles();
                    // Play cork pop sound for jump
                    this.playMp3Sound('jump');
                }
            }

                         startGame() {
                 console.log('Starting game...');
                 gameState.startGame();
                 this.titleScreen.style.display = 'none';
                 this.gameOverElement.style.display = 'none';
                 this.scoreElement.textContent = '0';
                 
                 // Reset mouse state, but NOT position (already handled)
                 gameState.mouse.velocity = 0;
                 gameState.mouse.rotation = 0;
                 gameState.mouse.isEating = false;
                 gameState.mouse.eatTimer = 0;
                 gameState.mouse.isDead = false;
                 gameState.mouse.deathAnimationPlayed = false;
                 
                 // Reset GIF animations
                 const gifPlayers = this.assetLoader.getAllGIFPlayers();
                 if (gifPlayers.normal) gifPlayers.normal.play();
                 if (gifPlayers.mouseEats) {
                     gifPlayers.mouseEats.pause();
                     gifPlayers.mouseEats.reset();
                 }
                 if (gifPlayers.dead) {
                     gifPlayers.dead.pause();
                     gifPlayers.dead.reset();
                 }
                 
                 // Create initial obstacles
                 this.gameLogic.createWineShelf();
             }

                         gameOver() {
                 console.log('Game Over called');
                 
                 // Exactly like the original
                 gameState.gameRunning = false;
                 
                 // Trigger death animation
                 gameState.mouse.isDead = true;
                 gameState.mouse.deathAnimationPlayed = false;
                 
                 // Update high score
                 if (gameState.score > gameState.highScore) {
                     gameState.highScore = gameState.score;
                 }
                 
                 this.finalScoreElement.innerHTML = 
                     `CHEESE COLLECTED: ${gameState.score}<br>HIGH SCORE: ${gameState.highScore}`;
                 this.gameOverElement.style.display = 'block';
                 
                 // Play death sound
                 this.playMp3Sound('mouseDies');
             }

            gameLoop() {
                const t0 = performance.now();

                gameState.frameCount++;
                
                // Clear canvas efficiently
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Apply screen shake
                this.ctx.save();
                if (this.renderer) {
                    const t_render_start = performance.now();
                    this.renderer.render();
                    this.perf.render += performance.now() - t_render_start;
                }
                
                                 if (gameState.gameRunning) {
                     // Update game logic
                     const t_update_start = performance.now();
                     if (this.mouse) this.mouse.update();
                     if (this.gameLogic) this.gameLogic.update();
                     this.perf.update += performance.now() - t_update_start;
                     
                     // Update score display
                     this.scoreElement.textContent = gameState.score;
                 }
                 

                
                                 // Always draw the mouse if game started (like in original)
                 if (this.mouse && gameState.gameStarted) {
                     const t_draw_start = performance.now();
                     this.mouse.draw();
                     this.perf.drawMouse += performance.now() - t_draw_start;
                 }
                
                // Update screen shake
                gameState.updateScreenShake();
                
                this.ctx.restore();
                
                this.perf.total += performance.now() - t0;
                this.perf.frameCount++;

                const now = performance.now();
                if (now - this.perf.lastLogTime > 1000) {
                    const avg_total = (this.perf.total / this.perf.frameCount).toFixed(2);
                    const avg_update = (this.perf.update / this.perf.frameCount).toFixed(2);
                    const avg_render = (this.perf.render / this.perf.frameCount).toFixed(2);
                    const avg_draw = (this.perf.drawMouse / this.perf.frameCount).toFixed(2);
                    console.log(`Perf (ms): Total=${avg_total}, Update=${avg_update}, Render=${avg_render}, DrawMouse=${avg_draw}`);
                    
                    this.perf.lastLogTime = now;
                    this.perf.frameCount = 0;
                    this.perf.update = 0;
                    this.perf.render = 0;
                    this.perf.drawMouse = 0;
                    this.perf.total = 0;
                }

                requestAnimationFrame(() => this.gameLoop());
            }
        }

        // Initialize and start the game
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, creating game...');
            const game = new CheesyMouseGame();
            game.init();
        });
    </script>
</body>
</html> 